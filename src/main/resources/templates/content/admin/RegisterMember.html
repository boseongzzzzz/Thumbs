<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" type="text/css" href="../css/sidebar.css">
    <link rel="stylesheet" type="text/css" href="../css/Manage.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    </script>


    <title>관리자 페이지</title>
</head>

<body>
<header>
    <div style="width:100%; float:right;">
        <div style="float: right; margin-right: 20px">
            <div style="float: left; margin-right: 30px">
                <h4 th:text="'관리자 계정 `'+ ${userId} +'` 로그인 중...'"></h4>
            </div>
            <div style="float: right;">
                <a href="/logout"><h4 style="font-weight: bold;">로그아웃</h4></a>
            </div>

        </div>
    </div>
</header>
<aside>
    <img class="logo" src="/image/THUMBS.png" alt="THUMBS.png">
    <div style="margin: 0px auto; text-align: center;">
        <div style="padding: 10px;">
            <h3>사원 관리</h3>
            <div style="margin: 10px; padding: 10px; clear: both;">
                <span><a href="/manage/register-member">신규 사원 추가</a></span><br><br>
                <span><a href="#">사원 정보 변경</a></span><br><br>
                <span><a href="#">사원 권한 변경</a></span><br><br>
            </div>
            <h3>부서 관리</h3>
            <div style="margin: 10px; padding: 10px; clear: both;">
                <span><a href="#">부서 편집</a></span><br><br>
            </div>
            <h3>문서 관리</h3>
            <div style="margin: 10px; padding: 10px; clear: both;">
                <span><a href="#">문서 복구</a></span><br><br>
            </div>
        </div>
    </div>
</aside>
<main>
    <div style="height: 100px; margin:10px; padding:10px"> <!-- 기본 폼 : 선택한 서식 및 현재 작업을 알려주는 헤드라인 -->
        <h1>신규 사원 추가</h1>
    </div>

    <div class="container">
        <form id="essential">
            <div style="clear: both; height: 620px; clear:both; border:1px solid lightgray; margin:10px; padding:50px; width:100%;">
                <h2>필수 입력 사항</h2><br>
                <div style="clear:both; border:1px solid lightgray; margin:10px; padding:30px; width:47%;">
                    <div style="clear:both; display: flex; width: 100%;">
                        <div class="col-md-4">
                            <label for="memberId" style="text-align: center; font-size: 15px;">사원번호 (아이디) :</label>
                        </div>
                        <div class="col-md-8">
                            <input type="number" class="form-control" id="memberId" name="memberId"
                                   placeholder="( 숫자만 입력 가능합니다. )"
                                   style="text-align: center; display: inline-block;" required>
                        </div>
                    </div>
                    <br>
                    <div style="clear: both; display: flex; width: 100%;">
                        <div class="col-md-4">
                            <label for="memberPw" style="text-align: center; font-size: 15px;">비밀번호 :</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="memberPw" name="memberPw"
                                   placeholder="비밀번호를 입력하세요."
                                   style="text-align: center; display: inline-block;" required>
                        </div>
                    </div>
                    <br>
                    <div style="clear: both; display: flex; width: 100%;">
                        <div class="col-md-4">
                            <label for="memberPwCon" style="text-align: center; font-size: 15px;">비밀번호 확인 :</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="memberPwCon" name="memberPwCon"
                                   placeholder="(위의 비밀번호와 같아야 합니다.)"
                                   style="text-align: center; display: inline-block;" required>
                        </div>
                    </div>
                </div>
                <div style="clear: both;">
                    <div style="height:230px; float:left; border:1px solid lightgray; margin:10px; padding:30px; width:47%;">
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberName" style="text-align: center; font-size: 15px;">이름 :</label>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="memberName" name="memberName"
                                       placeholder="이름을 입력하세요."
                                       style="text-align: center; display: inline-block;" required>
                            </div>
                        </div>
                        <br>
                        <div style="clear:both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberRegNo" style="text-align: center; font-size: 15px;">주민등록번호
                                    :</label>
                            </div>
                            <div class="col-md-8">
                                <input type="number" class="form-control" id="memberRegNo"
                                       name="memberRegNo"
                                       placeholder="( - 제외, 숫자만 입력 하세요. )"
                                       style="text-align: center; display: inline-block;" required>
                            </div>
                        </div>
                        <br>
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberGender" style="text-align: center; font-size: 15px;">성별
                                    :</label>
                            </div>
                            <div class="col-md-8">
                                <select class="form-select" name="memberGender" id="memberGender"
                                        style="text-align: center; height: 30px; width:100%;" required>
                                    <option value="">선택하세요.</option>
                                    <option value="F">여성</option>
                                    <option value="M">남성</option>
                                </select>
                                <!--                                <input type="text" name="memberGender" id="memberGender" style="visibility: hidden">-->
                            </div>
                        </div>
                    </div>
                    <div style="height: 230px; float: right; border:1px solid lightgray; margin:10px; padding:30px; width:47%;">
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberAuthority" style="text-align: center; font-size: 15px;">권한 설정
                                    :</label>
                            </div>
                            <div class="col-md-8">
                                <select class="form-select" id="memberAuthority" name="memberAuthority"
                                        style="text-align: center; height: 30px; width:100%;" required>
                                    <option value="">선택하세요.</option>
                                    <option value="EMPLOYEE">일반 사원</option>
                                    <option value="DOCU">문서 담당자</option>
                                    <option value="INSA">인사 담당자</option>
                                    <option value="ADMIN">프로그램 관리자</option>
                                </select>
                                <!--                                <input type="text" id="memberAuthority" name="memberAuthority"-->
                                <!--                                       style="visibility: hidden">-->
                            </div>
                        </div>
                        <br>
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberStatus" style="text-align: center; font-size: 15px;">상태 설정
                                    :</label>
                            </div>
                            <div class="col-md-8">
                                <select class="form-select" id="memberStatus" name="memberStatus"
                                        style="text-align: center; height: 30px; width:100%;" required>
                                    <option value="">선택하세요.</option>
                                    <option value="1">신규 사원</option>
                                    <option value="2">복직 사원</option>
                                    <option value="3">휴직(유급) 사원</option>
                                    <option value="4">휴직(무급) 사원</option>
                                    <option value="5">정직 사원</option>
                                </select>
                                <!--                                <input type="number" id="memberStatus" name="memberStatus"-->
                                <!--                                       style="visibility: hidden"></input>-->
                            </div>
                        </div>
                        <br>
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberJoinDate" style="text-align: center; font-size: 15px;">입사일
                                    :</label>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="memberJoinDate" name="memberJoinDate"
                                       placeholder="일자를 선택하세요.">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <form id="additional">
            <!--                <legend>Additional Information</legend>-->
            <div style="height: 430px; clear:both; border:1px solid lightgray; margin:10px; padding:50px; width:100%;">
                <h2>선택 입력 사항</h2>
                <div style="clear: both;">
                    <div style="float:left; border:1px solid lightgray; margin:10px; padding:30px; width:47%;">
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberEmail" style="text-align: center; font-size: 15px;">이메일 :</label>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="memberEmail"
                                       name="memberEmail" placeholder="이메일을 입력하세요."
                                       style="text-align: center; display: inline-block;">
                            </div>
                        </div>
                        <br>
                        <div style="clear: both; display: flex; width: 100%;">
                            <div class="col-md-4">
                                <label for="memberAddress" style="text-align: center; font-size: 15px;">주소 :</label>
                            </div>
                            <div class="col-md-8">
                                    <textarea class="form-control" id="memberAddress" name="memberAddress" rows="2"
                                              placeholder="거주지 주소를 입력하세요." style="width: 100%"></textarea>
                                <!--                                <input type="text" id="memberAddress" name="memberAddress" style="visibility: hidden">-->
                            </div>
                        </div>
                    </div>
                </div>
                <div style="float: right; border:1px solid lightgray; margin:10px; padding:30px; width:47%;">
                    <div style="clear: both; display: flex; width: 100%;">
                        <div class="col-md-4">
                            <label for="memberIntroduction" style="text-align: center; font-size: 15px;">자기 소개
                                :</label>
                        </div>
                        <div class="col-md-8">
                                <textarea class="form-control" id="memberIntroduction"
                                          name="memberIntroduction" rows="5"
                                          placeholder="자기소개를 입력하세요." style="width: 100%"></textarea>
                            <!--                            <input type="text" id="memberIntroduction" name="memberIntroduction"-->
                            <!--                                   style="visibility: hidden">-->
                        </div>
                    </div>
                </div>
                <!-- 기본 폼 : 붙임문서(첨부파일) 추가 -->
                <div style="float:left; margin:10px; width: 100%;">
                    <label for="file" style="font-size: 23px;">회원 사진 :</label>
                    <br>
                    <input type="file" style="border:none" id="file" class="img-thumbnail" accept="pictures/*">
                </div>
                <!--        &lt;!&ndash; 미리보기 &ndash;&gt; -->
                <!--        <div id="showImg2">-->
                <!--            <img id="showImg" style="width: 250px; height: 150px;">-->
                <!--            <br><br>-->
                <!--        </div>-->

            </div>
        </form>

        <script>
            $('input[type=file]').on("change", (function () {
                let formData = new FormData();
                formData.append("file", $("#file")[0].files[0]);

                $.ajax({
                    url: "register-member/addPicture",
                    type: 'post',
                    processData: false,
                    contentType: false,
                    cache: false,
                    data: formData,
                    success: function (pictureMember) {
                        alert("사진업로드에 성공하였습니다!");
                        $('#pictureMember').val(pictureMember);
                    }
                    , error: function () {
                        alert("실패하였습니다.");
                    }
                })
            }));
        </script>
        <!-- 숨겨진 필드 -->
        <div style="display:none">
            <!--        <input name="refundRule" th:value="${ param.refundRule }">-->
            <!--        <input name="tel" th:value="${ param.tel }">-->
            <!--        <input name="pjEmail" th:value="${ param.pjEmail }">-->
            <input name="memberPicture" id="memberPicture" th:value="${ param.memberPicture }">
        </div>

        <div style="clear:both; height: 100px;"> <!-- 기본 폼 : 임시저장 및 제출 -->
            <br>
            <div style="float: right; margin:10px; padding:10px;">
                <button class="btn btn-primary" onclick="submitForm()">사원 등록</button>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>

    <script>

        // 달력 초기 설정
        $(function () {
            $('#memberJoinDate').datepicker({
                format: "yyyy-mm-dd",
                autoclose: true,
                todayHighlight: true,
                immediateUpdate: true,
                title: "입사 일자",
            });

        });

        // // 셀렉트박스 입력값 처리
        //
        // // 1. 성별
        // let memberGenderSB = document.getElementById("memberGenderSB");
        // let memberGender = document.getElementById("memberGender");
        //
        // memberGenderSB.addEventListener("change", function () {
        //     let selectedOption = memberGenderSB.options[memberGenderSB.selectedIndex];
        //     memberGender.value = selectedOption.value;
        // });
        //
        // // 2. 권한
        // let memberAuthoritySB = document.getElementById("memberAuthoritySB");
        // let memberAuthority = document.getElementById("memberAuthority");
        //
        // memberAuthoritySB.addEventListener("change", function () {
        //     let selectedOption = memberAuthoritySB.options[memberAuthoritySB.selectedIndex];
        //     memberAuthority.value = selectedOption.value;
        // });
        //
        // // 3. 상태
        // let memberStatusSB = document.getElementById("memberStatusSB");
        // let memberStatus = document.getElementById("memberStatus");
        //
        // memberStatusSB.addEventListener("change", function () {
        //     let selectedOption = memberStatusSB.options[memberStatusSB.selectedIndex];
        //     memberStatus.value = selectedOption.value;
        // });
        //
        //
        // // 4. 주소
        // let memberAddressTA = document.getElementById("memberAddressTA");
        // let memberAddress = document.getElementById("memberAddress");
        //
        // memberAddressTA.addEventListener("input", function () {
        //     memberAddress.value = memberAddressTA.value;
        // });
        //
        //
        // // 5. 자기소개
        // let memberIntroductionTA = document.getElementById("memberIntroductionTA");
        // let memberIntroduction = document.getElementById("memberIntroduction");
        //
        // memberIntroductionTA.addEventListener("input", function () {
        //     memberIntroduction.value = memberIntroductionTA.value;
        // });


        // 등록 버튼 눌렀을 시 처리
        function submitForm() {

            // 유효성 체크에 사용할 할 변수 check 와, 오류 발생 시 띄워줄 message 선언
            let check = true;
            let message = "";

            // 사원번호 null 체크
            function checkMemberIdIsNull() {
                let memberId = document.getElementById("memberId").value.trim();
                if (memberId === "") {
                    message = "사원번호를 입력해주세요.";
                    check = false;
                    console.log("사원번호 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("사원번호 null 체크 통과 성공!")
            }

            // 사원번호 숫자값 체크
            function checkMemberId() {
                let memberId = document.getElementById("memberId");
                if (isNaN(memberId.value)) {
                    message = "사원번호는 숫자만 가능합니다.";
                    memberId.value = "";
                    check = false;
                    console.log("사원번호 숫자값 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("사원번호 숫자값 체크 통과 성공!")
            }

            // 비밀번호 null 체크
            function checkMemberPwIsNull() {
                let memberPw = document.getElementById("memberPw").value.trim();
                if (memberPw === "") {
                    message = "비밀번호를 입력해주세요.";
                    check = false;
                    console.log("비밀번호 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("비밀번호 null 체크 통과 성공!")
            }

            // 비밀번호 동일 체크
            function checkMemberPw() {
                let memberPw = document.getElementById("memberPw");
                let memberPwCon = document.getElementById("memberPwCon");
                if (memberPw.value != memberPwCon.value) {
                    message = "비밀번호와 비밀번호 확인란의 입력 부분이 다릅니다.";
                    memberPw.value = "";
                    memberPwCon.value = "";
                    check = false;
                    console.log("비밀번호 동일 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("비밀번호 동일 체크 통과 성공!")
            }

            // 이름 null 체크
            function checkMemberNameIsNull() {
                let memberName = document.getElementById("memberName").value.trim();
                if (memberName === "") {
                    message = "이름을 입력해주세요.";
                    check = false;
                    console.log("이름 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("이름 null 체크 통과 성공!")
            }

            // 성별 null 체크
            function checkMemberGenderIsNull() {
                let memberGender = document.getElementById("memberGender").value.trim();
                if (memberGender === "") {
                    message = "성별을 입력해주세요.";
                    check = false;
                    console.log("성별 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("성별 null 체크 통과 성공!")
            }

            // 주민번호 null 체크
            function checkMemberRegNoIsNull() {
                let memberRegNo = document.getElementById("memberRegNo").value.trim();
                if (memberRegNo === "") {
                    message = "주민번호를 입력해주세요.";
                    check = false;
                    console.log("주민번호 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("주민번호 null 체크 통과 성공!")
            }

            // 주민번호 숫자값 체크 및 처리
            function checkMemberRegNo() {
                let memberRegNo = document.getElementById("memberRegNo");
                if (isNaN(memberRegNo.value)) {
                    message = "주민번호는 숫자만 입력하세요.";
                    memberRegNo.value = "";
                    check = false;
                    console.log("주민번호 숫자값 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("주민번호 숫자값 체크 통과 성공!")
            }

            // 권한 null 체크
            function checkMemberAuthorityIsNull() {
                let memberAuthority = document.getElementById("memberAuthority").value.trim();
                if (memberAuthority === "") {
                    message = "권한을 입력해주세요.";
                    check = false;
                    console.log("권한 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("권한 null 체크 통과 성공!")
            }

            // 상태값 null 체크
            function checkMemberStatusIsNull() {
                let memberStatus = document.getElementById("memberStatus").value.trim();
                if (memberStatus === "") {
                    message = "회원 상태 값을 입력해주세요.";
                    check = false;
                    console.log("상태값 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("상태값 null 체크 통과 성공!")
            }

            // 입사일 null 체크
            function checkMemberJoinDateIsNull() {
                let memberJoinDate = document.getElementById("memberJoinDate").value.trim();
                if (memberJoinDate === "") {
                    message = "입사일 값을 입력해주세요.";
                    check = false;
                    console.log("입사일 null 체크 통과 실패!")
                    alert(message);
                    return;
                }
                console.log("입사일 null 체크 통과 성공!")
            }

            // 유효성 테스트 함수 모음
            let functions = [checkMemberIdIsNull, checkMemberId, checkMemberPwIsNull, checkMemberPw, checkMemberNameIsNull,
                checkMemberGenderIsNull, checkMemberRegNoIsNull, checkMemberRegNo,
                checkMemberAuthorityIsNull, checkMemberStatusIsNull, checkMemberJoinDateIsNull];


            // 위에 설정한 모든 '유효성 검사 함수를 반복문을 돌며 실행'
            while (check == true) {

                console.log("입력값 유효성 체크 함수 시작")

                for (let i = 0; i < functions.length; i++) {

                    functions[i]();
                    if (check == false) {
                        break;
                    }
                }
                if (check == false) {
                    console.log("유효성 체크 함수가 실패로 종료!");
                    break;
                }
                console.log("유효성 체크 함수들이 성공으로 종료, check='allTrue'로 변경");
                check = "allTrue"
            }


            // 모두 통과 시 드디어 값 넣고 넘겨줌
            if (check == "allTrue") {
                console.log("check='allTrue' 확인, controller로 값 넘겨주는 함수 실행");

                // 1. formData 처리

                // 1-1. 필수값
                let essential = new FormData();
                let essentialElements = document.querySelector("#essential");
                if (essentialElements) {
                    essentialElements.querySelectorAll("input, textarea, select").forEach(function (element) {
                        essential.append(element.id, element.value);
                    });
                }

                // 2-1. 추가값
                let additional = new FormData();
                let additionalElements = document.querySelector("#additional");
                if (additionalElements) {
                    additionalElements.querySelectorAll("input, textarea, select").forEach(function (element) {
                        additional.append(element.id, element.value);
                    });
                }

                // // formData 잡기
                // // 1-2. essential 필드셋의 데이터 append
                // let essentialInputs = essentialFieldset.querySelectorAll('input');
                // essentialInputs.forEach(input => {
                //     const name = input.getAttribute('name');
                //     const value = input.value;
                //     essential.append(name, value);
                // });
                //
                // // 2-1. additional 필드셋 -> formData 처리
                // let additionalFieldset = newMember.querySelector('#additional');
                // let additional = new FormData();
                //
                // // 2-2. additional 필드셋의 데이터 append
                // let additionalInputs = additionalFieldset.querySelectorAll('input');
                // additional.append('memberId', essential.get("memberId"));
                // additionalInputs.forEach(input => {
                //     const name = input.getAttribute('name');
                //     const value = input.value;
                //     additional.append(name, value);
                // });


                // 2. console로 확인
                console.log("java로 넘겨줄 폼데이터 essential : ");
                for (const [key, value] of essential.entries()) {
                    console.log(`${key}: ${value}`);
                }
                console.log("java로 넘겨줄 폼데이터 additional : ");
                for (const [key, value] of additional.entries()) {
                    console.log(`${key}: ${value}`);
                }


                // 3. Back으로 넘겨 처리
                console.log("필수정보 넘길 곳 : " + "manage/register-member/ess");
                console.log("추가정보 넘길 곳 : " + "manage/register-member/add");

                // 4-1. .필수 사원 정보 입력
                fetch("/manage/register-member/ess", {
                    method: 'POST',
                    body: essential
                })
                    .then(response => {
                        if (response.ok) {
                            alert('"필수" 사원정보 등록 성공!');

                            // 4-2.부가 사원 정보 입력
                            fetch("/manage/register-member/add", {
                                method: 'POST',
                                body: additional
                            })
                                .then(response => {
                                    if (response.ok) {
                                        alert('"선택" 사원정보 등록 성공!');
                                    } else {
                                        alert('"선택" 사원정보 등록 실패!');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                });

                        } else {
                            alert('"필수"z5 사원정보 등록 실패!');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

            }

        }

    </script>
</main>
</body>

</html>